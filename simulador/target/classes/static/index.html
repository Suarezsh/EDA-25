<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Estructuras de Datos Avanzado</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            padding-top: 70px;
            background-color: #eef2f7;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        .navbar {
            background-color: #0d6efd;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .navbar-brand, .nav-link {
            color: white !important;
        }
        .navbar-brand:hover, .nav-link:hover {
            color: #cce5ff !important;
        }
        .container {
            max-width: 1200px;
            margin-top: 20px;
        }
        .card {
            margin-bottom: 25px;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15) !important;
            border: none;
            border-radius: 10px;
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-weight: 500;
            border-radius: 10px 10px 0 0;
            padding: 15px 20px;
            font-size: 1.2em;
        }
        .card-body {
            padding: 25px;
            background-color: #fff;
            border-radius: 0 0 10px 10px;
        }
        .operations-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
        }
        .form-control {
            border-radius: 5px;
        }
        .btn {
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn-success { background-color: #198754; border-color: #198754; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        .btn-info { background-color: #0dcaf0; border-color: #0dcaf0; color: #000; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }

        .output-area, .explanation-area {
            white-space: pre-wrap;
            padding: 15px;
            border-radius: 5px;
            min-height: 150px;
            overflow-y: auto;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .output-area {
            background-color: #212529;
            color: #28a745;
            border: 1px solid #495057;
        }
        .explanation-area {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        .loading-message {
            color: #6c757d;
            font-style: italic;
        }
        .error-message {
            color: #dc3545;
            font-weight: bold;
        }
        .node circle {
            fill: #0d6efd;
            stroke: #007bff;
            stroke-width: 2px;
            cursor: pointer;
        }
        .node text {
            font-family: sans-serif;
            font-size: 12px;
            text-anchor: middle;
            dominant-baseline: middle;
            fill: white;
            pointer-events: none;
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }
        .tree-container {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            background-color: #fff;
            border-radius: 8px;
            margin-top: 20px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .tree-container svg {
            display: block;
        }
        .explanation-detail {
            font-size: 0.9em;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid #0d6efd;
        }
        .concept-box {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
        }
        .concept-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #0d6efd;
            margin-bottom: 10px;
        }
        .concept-content {
            font-size: 0.95em;
            color: #555;
            line-height: 1.6;
        }
        .modal-header {
            background-color: #0d6efd;
            color: white;
        }
        .modal-title {
            font-weight: 500;
        }
        .modal-body {
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Simulador Estructuras</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#arbolBinarioSection">Árbol Binario</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#arbolAVLSection">Árbol AVL</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#splayTreeSection">Splay Tree</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#arbolBSection">Árbol B</a>
                    </li>
                </ul>
                <button id="btnTestApi" class="btn btn-outline-light">Test API</button>
                <span id="apiStatus" class="ms-3 text-light"></span>
            </div>
        </div>
    </nav>

    <div class="container">

        <div class="text-center mb-5">
            <h1 class="display-4">Simulador de Estructuras de Datos</h1>
            <p class="lead">Visualiza y manipula Árbol Binario, AVL, Splay Tree y Árbol B.</p>
        </div>

        <div id="arbolBinarioSection" class="struct-section card">
            <div class="card-header">Árbol Binario de Búsqueda</div>
            <div class="card-body">
                <div class="concept-box">
                    <div class="concept-title">¿Qué es un Árbol Binario de Búsqueda?</div>
                    <div class="concept-content">
                        Un Árbol Binario de Búsqueda (BST) es una estructura de datos en árbol donde cada nodo tiene como máximo dos hijos. Para cualquier nodo, todos los valores en su subárbol izquierdo son menores que el valor del nodo, y todos los valores en su subárbol derecho son mayores. Esto permite búsquedas eficientes (en promedio O(log n)).
                    </div>
                    <button class="btn btn-outline-primary btn-sm mt-3" data-bs-toggle="modal" data-bs-target="#modalArbolBinario">Ver Ejemplo Básico</button>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="operations-form">
                            <div class="form-group flex-grow-1 me-2">
                                <label for="inputInsertarBinario" class="form-label">Insertar:</label>
                                <input type="number" class="form-control" id="inputInsertarBinario" placeholder="Ej: 50">
                            </div>
                            <button id="btnInsertarBinario" class="btn btn-success">Insertar</button>

                            <div class="form-group flex-grow-1 me-2">
                                <label for="inputEliminarBinario" class="form-label">Eliminar:</label>
                                <input type="number" class="form-control" id="inputEliminarBinario" placeholder="Ej: 30">
                            </div>
                            <button id="btnEliminarBinario" class="btn btn-danger">Eliminar</button>

                            <div class="col-12 mt-3">
                                <button id="btnMostrarBinario" class="btn btn-primary me-2">Mostrar Árbol</button>
                                <button id="btnObtenerExplicacionBinario" class="btn btn-secondary">Última Explicación</button>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <label for="outputArbolBinario" class="form-label">Representación Textual:</label>
                                <div id="outputArbolBinario" class="output-area">
                                    Esperando acción...
                                </div>
                            </div>
                            <div class="col-12 mt-3">
                                <label for="explanationArbolBinario" class="form-label">Explicación:</label>
                                <div id="explanationArbolBinario" class="explanation-area">
                                    Realiza una operación para ver detalles.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Visualización Gráfica:</label>
                        <div id="treeContainerBinario" class="tree-container">
                            <p class="text-center w-100">Cargando visualización...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="arbolAVLSection" class="struct-section card">
            <div class="card-header">Árbol AVL</div>
            <div class="card-body">
                <div class="concept-box">
                    <div class="concept-title">¿Qué es un Árbol AVL?</div>
                    <div class="concept-content">
                        Un Árbol AVL es un árbol binario de búsqueda auto-balanceado. Para cada nodo, la diferencia de altura entre su subárbol izquierdo y derecho (factor de balance) es como máximo 1. Esto garantiza que las operaciones de inserción, eliminación y búsqueda tengan una complejidad de tiempo logarítmica O(log n) en el peor de los casos.
                    </div>
                    <button class="btn btn-outline-primary btn-sm mt-3" data-bs-toggle="modal" data-bs-target="#modalArbolAVL">Ver Ejemplo Básico</button>
                </div>
                 <div class="row">
                    <div class="col-md-6">
                        <div class="operations-form">
                            <div class="form-group flex-grow-1 me-2">
                                <label for="inputInsertarAVL" class="form-label">Insertar:</label>
                                <input type="number" class="form-control" id="inputInsertarAVL" placeholder="Ej: 40">
                            </div>
                            <button id="btnInsertarAVL" class="btn btn-success">Insertar</button>

                            <div class="form-group flex-grow-1 me-2">
                                <label for="inputEliminarAVL" class="form-label">Eliminar:</label>
                                <input type="number" class="form-control" id="inputEliminarAVL" placeholder="Ej: 20">
                            </div>
                            <button id="btnEliminarAVL" class="btn btn-danger">Eliminar</button>

                            <div class="col-12 mt-3">
                                <button id="btnMostrarAVL" class="btn btn-primary me-2">Mostrar Árbol</button>
                                <button id="btnObtenerExplicacionAVL" class="btn btn-secondary">Última Explicación</button>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <label for="outputArbolAVL" class="form-label">Representación Textual:</label>
                                <div id="outputArbolAVL" class="output-area">
                                    Esperando acción...
                                </div>
                            </div>
                            <div class="col-12 mt-3">
                                <label for="explanationArbolAVL" class="form-label">Explicación:</label>
                                <div id="explanationArbolAVL" class="explanation-area">
                                    Realiza una operación para ver detalles.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                         <label class="form-label">Visualización Gráfica:</label>
                        <div id="treeContainerAVL" class="tree-container">
                            <p class="text-center w-100">Cargando visualización...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="splayTreeSection" class="struct-section card">
            <div class="card-header">Splay Tree</div>
            <div class="card-body">
                <div class="concept-box">
                    <div class="concept-title">¿Qué es un Splay Tree?</div>
                    <div class="concept-content">
                        Un Splay Tree es un árbol binario de auto-balanceo que, tras cada operación de acceso (búsqueda, inserción, eliminación), mueve el nodo accedido a la raíz mediante una serie de rotaciones (zig, zig-zig, zig-zag). Aunque su complejidad en el peor de los casos para una operación es O(n), su amortización para una secuencia de m operaciones es O(log n), haciéndolo muy eficiente en la práctica para acceso frecuente a ciertos datos.
                    </div>
                    <button class="btn btn-outline-primary btn-sm mt-3" data-bs-toggle="modal" data-bs-target="#modalSplayTree">Ver Ejemplo Básico</button>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="operations-form">
                            <div class="form-group flex-grow-1 me-2">
                                <label for="inputInsertarSplay" class="form-label">Insertar:</label>
                                <input type="number" class="form-control" id="inputInsertarSplay" placeholder="Ej: 60">
                            </div>
                            <button id="btnInsertarSplay" class="btn btn-success">Insertar</button>

                            <div class="form-group flex-grow-1 me-2">
                                <label for="inputEliminarSplay" class="form-label">Eliminar:</label>
                                <input type="number" class="form-control" id="inputEliminarSplay" placeholder="Ej: 50">
                            </div>
                            <button id="btnEliminarSplay" class="btn btn-danger">Eliminar</button>

                            <div class="col-12 mt-3">
                                <button id="btnMostrarSplay" class="btn btn-primary me-2">Mostrar Árbol</button>
                                <button id="btnObtenerExplicacionSplay" class="btn btn-secondary">Última Explicación</button>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <label for="outputSplayTree" class="form-label">Representación Textual:</label>
                                <div id="outputSplayTree" class="output-area">
                                    Esperando acción...
                                </div>
                            </div>
                            <div class="col-12 mt-3">
                                <label for="explanationSplayTree" class="form-label">Explicación:</label>
                                <div id="explanationSplayTree" class="explanation-area">
                                    Realiza una operación para ver detalles.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Visualización Gráfica:</label>
                        <div id="treeContainerSplay" class="tree-container">
                            <p class="text-center w-100">Cargando visualización...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="arbolBSection" class="struct-section card">
            <div class="card-header">Árbol B (Grado 3)</div>
            <div class="card-body">
                <div class="concept-box">
                    <div class="concept-title">¿Qué es un Árbol B?</div>
                    <div class="concept-content">
                        Un Árbol B es una estructura de datos en árbol auto-balanceada que generaliza el árbol binario de búsqueda. Cada nodo puede tener muchos hijos (al menos 2 y como máximo $2t$, donde $t$ es el grado del árbol), y cada nodo interno (excepto la raíz) tiene al menos $t-1$ claves y como máximo $2t-1$ claves. Son comunes en sistemas de bases de datos y sistemas de archivos porque minimizan el número de accesos a disco.
                    </div>
                    <button class="btn btn-outline-primary btn-sm mt-3" data-bs-toggle="modal" data-bs-target="#modalArbolB">Ver Ejemplo Básico</button>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="operations-form">
                            <div class="form-group flex-grow-1 me-2">
                                <label for="inputInsertarArbolB" class="form-label">Insertar:</label>
                                <input type="number" class="form-control" id="inputInsertarArbolB" placeholder="Ej: 20">
                            </div>
                            <button id="btnInsertarArbolB" class="btn btn-success">Insertar</button>

                            <div class="form-group flex-grow-1 me-2">
                                <label for="inputEliminarArbolB" class="form-label">Eliminar:</label>
                                <input type="number" class="form-control" id="inputEliminarArbolB" placeholder="Ej: 30">
                            </div>
                            <button id="btnEliminarArbolB" class="btn btn-danger">Eliminar</button>

                            <div class="col-12 mt-3">
                                <button id="btnMostrarArbolB" class="btn btn-primary me-2">Mostrar Árbol</button>
                                <button id="btnObtenerExplicacionArbolB" class="btn btn-secondary">Última Explicación</button>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <label for="outputArbolB" class="form-label">Representación Textual:</label>
                                <div id="outputArbolB" class="output-area">
                                    Esperando acción...
                                </div>
                            </div>
                            <div class="col-12 mt-3">
                                <label for="explanationArbolB" class="form-label">Explicación:</label>
                                <div id="explanationArbolB" class="explanation-area">
                                    Realiza una operación para ver detalles.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Visualización Gráfica:</label>
                        <div id="treeContainerArbolB" class="tree-container">
                            <p class="text-center w-100">Cargando visualización...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modalArbolBinario" tabindex="-1" aria-labelledby="modalArbolBinarioLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalArbolBinarioLabel">Ejemplo Básico: Árbol Binario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Inserción:</strong></p>
                    <p>Insertar 50: El nodo 50 se convierte en la raíz.</p>
                    <p>Insertar 30: 30 es menor que 50, va a la izquierda.</p>
                    <p>Insertar 70: 70 es mayor que 50, va a la derecha.</p>
                    <p>Insertar 20: 20 &lt; 50 (izq), 20 &lt; 30 (izq). Queda como hijo izquierdo de 30.</p>
                    <p>Insertar 40: 40 &lt; 50 (izq), 40 &gt; 30 (der). Queda como hijo derecho de 30.</p>
                    <p><strong>Estructura resultante:</strong></p>
                    <pre>
      50
     /  \
    30  70
   /  \
  20  40
                    </pre>
                    <p><strong>Eliminación de un nodo hoja (ej: 20):</strong></p>
                    <p>Simplemente se remueve el nodo.</p>
                    <p><strong>Eliminación de un nodo con un hijo (ej: 30):</strong></p>
                    <p>El hijo (o el mayor de la izquierda/menor de la derecha) reemplaza al nodo.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Árbol AVL -->
    <div class="modal fade" id="modalArbolAVL" tabindex="-1" aria-labelledby="modalArbolAVLLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalArbolAVLLabel">Ejemplo Básico: Árbol AVL</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Propiedad clave:</strong> El factor de balance (altura_izquierda - altura_derecha) de cada nodo es -1, 0 o 1.</p>
                    <p><strong>Inserción con desbalance:</strong></p>
                    <p>Insertar 10, 20, 30. Al insertar 30, el nodo 10 se desbalancea (balance = -2).</p>
                    <p>Se aplica una rotación simple a la izquierda en 10. El árbol se reestructura.</p>
                    <p><strong>Árbol inicial (con alturas y balances):</strong></p>
                    <pre>
    10 (H:2, B:-2)
      \
       20 (H:1, B:-1)
         \
          30 (H:0, B:0)
                    </pre>
                    <p><strong>Después de rotación a la izquierda en 10:</strong></p>
                    <pre>
      20 (H:1, B:0)
     /  \
    10  30
                    </pre>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSplayTree" tabindex="-1" aria-labelledby="modalSplayTreeLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalSplayTreeLabel">Ejemplo Básico: Splay Tree</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Operación clave:</strong> El nodo accedido se mueve a la raíz mediante splaying.</p>
                    <p><strong>Inserción:</strong> Se inserta normalmente y luego se splayea el nuevo nodo a la raíz.</p>
                    <p><strong>Ejemplo: Insertar 50, luego 30, luego 20.</strong></p>
                    <p>1. Insertar 50: Raíz = 50.</p>
                    <p>2. Insertar 30: 30 &lt; 50 (izq). Se splayea 30. Raíz = 30, 50 es su hijo derecho.</p>
                    <p>3. Insertar 20: 20 &lt; 30 (izq). Se splayea 20. Raíz = 20, 30 es su hijo derecho.</p>
                    <p><strong>Estructura final:</strong></p>
                    <pre>
      20
        \
         30
           \
            50
                    </pre>
                    <p>Si ahora se busca 50, se splayea 50 a la raíz.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalArbolB" tabindex="-1" aria-labelledby="modalArbolBLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalArbolBLabel">Ejemplo Básico: Árbol B (Grado 3)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Grado t=3:</strong> Cada nodo interno (excepto raíz) tiene entre 2 y 6 hijos. Cada nodo tiene entre 1 y 5 claves.</p>
                    <p><strong>Inserción:</strong></p>
                    <p>Insertar 10, 20, 30. Se colocan en la raíz.</p>
                    <p>Insertar 40, 50. Se colocan en la raíz. Raíz: [10, 20, 30, 40, 50]</p>
                    <p>Insertar 60. Raíz [10, 20, 30, 40, 50] está llena. Se divide.</p>
                    <p>Clave mediana (30) sube a nueva raíz. La vieja raíz se divide:</p>
                    <p><strong>Nodos después de dividir raíz:</strong></p>
                    <pre>
         [30]
       /      \
    [10, 20]  [40, 50, 60]
                    </pre>
                    <p>Ahora se inserta 60. Baja a la raíz [30]. 60 &gt; 30 (der). Va al nodo [40, 50, 60].</p>
                    <p>El nodo [40, 50, 60] está lleno. Se divide.</p>
                    <p>Clave mediana (50) sube al nodo padre [30].</p>
                    <p><strong>Estructura final:</strong></p>
                    <pre>
         [30, 50]
       /    |    \
    [10, 20] [40] [60]
                    </pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';

        function updateTextOutput(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            if (isError) {
                element.classList.add('error-message');
            } else {
                element.classList.remove('error-message');
            }
        }

        function showLoading(elementId, message = "Cargando...") {
            const element = document.getElementById(elementId);
            element.innerHTML = `<span class="loading-message">${message}</span>`;
            element.classList.remove('error-message');
        }

        async function fetchApi(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText || 'Unknown error'}`);
                }

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return await response.json();
                } else {
                    return await response.text();
                }
            } catch (error) {
                console.error(`Error en fetchApi (${url}):`, error);
                throw error;
            }
        }

        function parseTreeDataGeneric(textRepresentation) {
            if (!textRepresentation || textRepresentation.length === 0 || typeof textRepresentation === 'string' && textRepresentation.startsWith('El')) {
                return null;
            }

            const lines = Array.isArray(textRepresentation) ? textRepresentation : textRepresentation.split('\n');
            if (lines.length === 0 || lines[0].startsWith('El')) return null;

            const nodeMap = new Map();

            lines.forEach(line => {
                const match = line.match(/^(\s*)- (\S+)(?:\(H:.*?\))?(?: \(Izq: (.*?)(?:, Der: (.*?))?\))?$/);
                if (match) {
                    const value = match[2];
                    if (!nodeMap.has(value)) {
                        nodeMap.set(value, { name: value, children: [] });
                    }
                }
            });

            lines.forEach(line => {
                const match = line.match(/^(\s*)- (\S+)(?:\(H:.*?\))?(?: \(Izq: (.*?)(?:, Der: (.*?))?\))?$/);
                if (!match) return;

                const nodeValue = match[2];
                const leftChildValue = match[3] || null;
                const rightChildValue = match[4] || null;

                const currentNode = nodeMap.get(nodeValue);

                if (leftChildValue && nodeMap.has(leftChildValue)) {
                    currentNode.children.push(nodeMap.get(leftChildValue));
                }
                if (rightChildValue && nodeMap.has(rightChildValue)) {
                    currentNode.children.push(nodeMap.get(rightChildValue));
                }
            });

            const rootMatch = lines[0].match(/^(\s*)- (\S+)/);
            return rootMatch ? nodeMap.get(rootMatch[2]) : null;
        }

        function parseTreeDataAVL(textRepresentation) {
            if (!textRepresentation || textRepresentation.length === 0 || typeof textRepresentation === 'string' && textRepresentation.startsWith('El')) {
                return null;
            }

            const lines = Array.isArray(textRepresentation) ? textRepresentation : textRepresentation.split('\n');
            if (lines.length === 0 || lines[0].startsWith('El')) return null;

            const nodeMap = new Map();

            const avlLineRegex = /^(\s*)- (\d+)\(H:\d+\)(?: \(Izq: (\d+)(?:, Der: (\d+))?\))?$/;

            lines.forEach(line => {
                const match = line.match(avlLineRegex);
                if (match) {
                    const value = match[2];
                    if (!nodeMap.has(value)) {
                        nodeMap.set(value, { name: value, children: [] });
                    }
                }
            });

            lines.forEach(line => {
                const match = line.match(avlLineRegex);
                if (!match) return;

                const nodeValue = match[2];
                const leftChildValue = match[3] || null;
                const rightChildValue = match[4] || null;

                const currentNode = nodeMap.get(nodeValue);

                if (leftChildValue && nodeMap.has(leftChildValue)) {
                    currentNode.children.push(nodeMap.get(leftChildValue));
                }
                if (rightChildValue && nodeMap.has(rightChildValue)) {
                    currentNode.children.push(nodeMap.get(rightChildValue));
                }
            });

            const rootMatch = lines[0].match(/^(\s*)- (\d+)/);
            return rootMatch ? nodeMap.get(rootMatch[2]) : null;
        }


        function renderTree(svgElement, treeData, treeType) {
            svgElement.innerHTML = '';

            if (!treeData) {
                svgElement.innerHTML = '<p class="text-center w-100">El árbol está vacío o no se pudo cargar.</p>';
                return;
            }

            const width = svgElement.clientWidth;
            const height = svgElement.clientHeight;
            const marginTop = 50;
            const marginLeft = 50;
            const marginRight = 50;
            const marginBottom = 20;
            const treeHeight = height - marginTop - marginBottom;

            const treeLayout = d3.tree().size([width - marginLeft - marginRight, treeHeight]);

            const root = d3.hierarchy(treeData);
            const tree = treeLayout(root);

            const svg = d3.select(svgElement)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${marginLeft}, ${marginTop})`);

            const links = svg.selectAll(".link")
                .data(tree.links())
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d3.linkVertical()
                    .x(d => d.x)
                    .y(d => d.y)
                );

            const nodes = svg.selectAll(".node")
                .data(tree.descendants())
                .enter()
                .append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            nodes.append("circle")
                .attr("r", 18);

            nodes.append("text")
                .attr("dy", "0.31em")
                .text(d => d.data.name);
        }

        async function handleInsert(apiEndpoint, inputElement, outputElement, explanationElement, containerElement, treeType) {
            const dato = inputElement.value.trim();
            if (!dato) {
                updateTextOutput(outputElement, 'Por favor, ingrese un valor.', true);
                updateTextOutput(explanationElement, 'Valor no válido ingresado.', true);
                return;
            }
            const valor = parseInt(dato, 10);
            if (isNaN(valor)) {
                updateTextOutput(outputElement, 'Por favor, ingrese un número válido.', true);
                updateTextOutput(explanationElement, 'Valor numérico no válido.', true);
                return;
            }

            showLoading(outputElement, `Insertando ${valor}...`);
            updateTextOutput(explanationElement, 'Procesando inserción...');

            try {
                const message = await fetchApi(`${API_BASE_URL}/${apiEndpoint}/insertar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(valor)
                });
                updateTextOutput(outputElement, message);
                updateTextOutput(explanationElement, message);
                inputElement.value = '';

                await refreshTree(apiEndpoint, outputElement, explanationElement, containerElement, treeType);

            } catch (error) {
                updateTextOutput(outputElement, `Error al insertar ${valor}: ${error.message}`, true);
                updateTextOutput(explanationElement, `Fallo la inserción de ${valor}.`, true);
            }
        }

        async function handleDelete(apiEndpoint, inputElement, outputElement, explanationElement, containerElement, treeType) {
            const dato = inputElement.value.trim();
            if (!dato) {
                updateTextOutput(outputElement, 'Por favor, ingrese un valor para eliminar.', true);
                updateTextOutput(explanationElement, 'Valor no válido ingresado.', true);
                return;
            }
            const valor = parseInt(dato, 10);
             if (isNaN(valor)) {
                updateTextOutput(outputElement, 'Por favor, ingrese un número válido.', true);
                updateTextOutput(explanationElement, 'Valor numérico no válido.', true);
                return;
            }

            showLoading(outputElement, `Eliminando ${valor}...`);
            updateTextOutput(explanationElement, 'Procesando eliminación...');

            try {
                const message = await fetchApi(`${API_BASE_URL}/${apiEndpoint}/eliminar`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(valor)
                });
                updateTextOutput(outputElement, message);
                updateTextOutput(explanationElement, message);
                inputElement.value = '';

                await refreshTree(apiEndpoint, outputElement, explanationElement, containerElement, treeType);

            } catch (error) {
                updateTextOutput(outputElement, `Error al eliminar ${valor}: ${error.message}`, true);
                updateTextOutput(explanationElement, `Fallo la eliminación de ${valor}.`, true);
            }
        }

        async function refreshTree(apiEndpoint, outputElement, explanationElement, containerElement, treeType) {
            showLoading(outputElement, 'Obteniendo representación...');
            showLoading(explanationElement, 'Obteniendo última operación...');

            try {
                const representation = await fetchApi(`${API_BASE_URL}/${apiEndpoint}/mostrar`);
                if (Array.isArray(representation)) {
                    updateTextOutput(outputElement, representation.join('\n'));
                } else {
                    updateTextOutput(outputElement, representation);
                }

                const explanation = await fetchApi(`${API_BASE_URL}/${apiEndpoint}/explicacion`);
                updateTextOutput(explanationElement, explanation);

                let treeData = null;
                if (treeType === 'binario' || treeType === 'splay') {
                    treeData = parseTreeDataGeneric(representation);
                } else if (treeType === 'avl') {
                    treeData = parseTreeDataAVL(representation);
                }

                if (containerElement) {
                    if (treeType === 'arbolB') {
                         containerElement.innerHTML = '<p class="text-center w-100">Visualización avanzada para Árbol B no implementada.</p>';
                    } else {
                        renderTree(containerElement, treeData, treeType);
                    }
                }

            } catch (error) {
                updateTextOutput(outputElement, `Error al obtener datos del árbol: ${error.message}`, true);
                updateTextOutput(explanationElement, `Error al obtener explicación: ${error.message}`, true);
                if (containerElement) {
                    containerElement.innerHTML = `<p class="text-center error-message">${error.message}</p>`;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            refreshTree('arbol-binario', 'outputArbolBinario', 'explanationArbolBinario', treeContainerBinario, 'binario');
            refreshTree('arbol-avl', 'outputArbolAVL', 'explanationArbolAVL', treeContainerAVL, 'avl');
            refreshTree('splay-tree', 'outputSplayTree', 'explanationSplayTree', treeContainerSplay, 'splay');
            refreshTree('arbol-b', 'outputArbolB', 'explanationArbolB', treeContainerArbolB, 'arbolB');
        });

        btnTestApi.addEventListener('click', async () => {
            updateTextOutput('apiStatus', 'Probando...');
            try {
                const response = await fetchApi(`${API_BASE_URL}/hola`);
                updateTextOutput('apiStatus', response);
            } catch (error) {
                updateTextOutput('apiStatus', `Error: ${error.message}`, true);
            }
        });

        btnInsertarBinario.addEventListener('click', () => handleInsert('arbol-binario', inputInsertarBinario, 'outputArbolBinario', 'explanationArbolBinario', treeContainerBinario, 'binario'));
        btnEliminarBinario.addEventListener('click', () => handleDelete('arbol-binario', inputEliminarBinario, 'outputArbolBinario', 'explanationArbolBinario', treeContainerBinario, 'binario'));
        btnMostrarBinario.addEventListener('click', () => refreshTree('arbol-binario', 'outputArbolBinario', 'explanationArbolBinario', treeContainerBinario, 'binario'));
        btnObtenerExplicacionBinario.addEventListener('click', async () => {
            try {
                const explanation = await fetchApi(`${API_BASE_URL}/arbol-binario/explicacion`);
                updateTextOutput('explanationArbolBinario', explanation);
            } catch (error) {
                updateTextOutput('explanationArbolBinario', `Error al obtener explicación: ${error.message}`, true);
            }
        });

        btnInsertarAVL.addEventListener('click', () => handleInsert('arbol-avl', inputInsertarAVL, 'outputArbolAVL', 'explanationArbolAVL', treeContainerAVL, 'avl'));
        btnEliminarAVL.addEventListener('click', () => handleDelete('arbol-avl', inputEliminarAVL, 'outputArbolAVL', 'explanationArbolAVL', treeContainerAVL, 'avl'));
        btnMostrarAVL.addEventListener('click', () => refreshTree('arbol-avl', 'outputArbolAVL', 'explanationArbolAVL', treeContainerAVL, 'avl'));
        btnObtenerExplicacionAVL.addEventListener('click', async () => {
            try {
                const explanation = await fetchApi(`${API_BASE_URL}/arbol-avl/explicacion`);
                updateTextOutput('explanationArbolAVL', explanation);
            } catch (error) {
                updateTextOutput('explanationArbolAVL', `Error al obtener explicación: ${error.message}`, true);
            }
        });

        btnInsertarSplay.addEventListener('click', () => handleInsert('splay-tree', inputInsertarSplay, 'outputSplayTree', 'explanationSplayTree', treeContainerSplay, 'splay'));
        btnEliminarSplay.addEventListener('click', () => handleDelete('splay-tree', inputEliminarSplay, 'outputSplayTree', 'explanationSplayTree', treeContainerSplay, 'splay'));
        btnMostrarSplay.addEventListener('click', () => refreshTree('splay-tree', 'outputSplayTree', 'explanationSplayTree', treeContainerSplay, 'splay'));
        btnObtenerExplicacionSplay.addEventListener('click', async () => {
            try {
                const explanation = await fetchApi(`${API_BASE_URL}/splay-tree/explicacion`);
                updateTextOutput('explanationSplayTree', explanation);
            } catch (error) {
                updateTextOutput('explanationSplayTree', `Error al obtener explicación: ${error.message}`, true);
            }
        });

        btnInsertarArbolB.addEventListener('click', () => handleInsert('arbol-b', inputInsertarArbolB, 'outputArbolB', 'explanationArbolB', treeContainerArbolB, 'arbolB'));
        btnEliminarArbolB.addEventListener('click', () => handleDelete('arbol-b', inputEliminarArbolB, 'outputArbolB', 'explanationArbolB', treeContainerArbolB, 'arbolB'));
        btnMostrarArbolB.addEventListener('click', () => refreshTree('arbol-b', 'outputArbolB', 'explanationArbolB', treeContainerArbolB, 'arbolB'));
        btnObtenerExplicacionArbolB.addEventListener('click', async () => {
            try {
                const explanation = await fetchApi(`${API_BASE_URL}/arbol-b/explicacion`);
                updateTextOutput('explanationArbolB', explanation);
            } catch (error) {
                updateTextOutput('explanationArbolB', `Error al obtener explicación: ${error.message}`, true);
            }
        });
    </script>

</body>
</html>